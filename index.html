<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>New Emerald Tour - Elite Scoreboard</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --emerald-primary: #2e7d32;
      --emerald-dark: #1b5e20;
      --round2-blue: #1565c0;
      --round2-dark: #0d47a1;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(255, 255, 255, 0.3);
      --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    html, body { width: 100%; margin: 0; padding: 0; background: #e8ecef; background-image: linear-gradient(135deg, #e8ecef 0%, #c8e6c9 100%); background-attachment: fixed; }
    body { font-family: 'Inter', -apple-system, sans-serif; padding: 10px; box-sizing: border-box; }
    
    /* REFINED HEADER SECTION */
    .header-block { text-align: center; margin-bottom: 20px; }
    .brand-main { font-size: 1.2rem; font-weight: 900; letter-spacing: 5px; text-transform: uppercase; color: var(--emerald-dark); margin: 0; }
    .sub-brand { font-size: 0.9rem; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; color: #555; margin: 4px 0; }
    .venue-input { 
      border: none; background: transparent; font-weight: 800; text-align: center; 
      color: #000; width: 80%; font-size: 1.4rem; text-transform: uppercase; margin-top: 5px;
    }

    #capture-area { padding: 15px 10px; border-radius: 16px; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); border: 1px solid var(--glass-border); }

    .table-wrapper { 
      width: 100%; overflow-x: auto; border-radius: 12px; box-shadow: var(--shadow-soft); 
      margin-bottom: 20px; background: var(--glass-bg); border: 1px solid var(--glass-border);
      -webkit-overflow-scrolling: touch;
    }
    
    table { border-collapse: separate; border-spacing: 0; }
    th, td { text-align: center; vertical-align: middle; white-space: nowrap; }
    
    /* Dynamic Round Colors */
    .round-1-theme th { background: linear-gradient(180deg, var(--emerald-primary), var(--emerald-dark)); }
    .round-2-theme th { background: linear-gradient(180deg, var(--round2-blue), var(--round2-dark)); }
    
    th { color: white; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; padding: 12px 4px; }
    td { border-bottom: 1px solid rgba(0,0,0,0.05); border-right: 1px solid rgba(0,0,0,0.05); }

    .col-name { width: 160px; min-width: 160px; }
    .col-hcp, .col-team { width: 45px; min-width: 45px; }
    .col-hole { width: 44px; min-width: 44px; }
    .col-total { width: 65px; min-width: 65px; }

    @media screen and (orientation: landscape) { table { width: 1100px; } }

    .score-input, .par-input, .si-input { 
      width: 34px; height: 34px; border: 1px solid #ddd; text-align: center; border-radius: 4px; 
      font-weight: 700; background: white; font-size: 0.95rem; margin: 0 auto; display: block;
    }
    
    .player-name-input { font-weight: 800; border: none; background: transparent; color: #333; font-size: 0.9rem; padding-left: 5px; width: 100%; }
    
    /* SHAPES */
    .eagle { background: #ffd700 !important; color: #000 !important; border-radius: 50%; border: 1px solid #b8860b !important; }
    .birdie { background: #d32f2f !important; color: white !important; border-radius: 50%; }
    .par-gross { background: #2e7d32 !important; color: white !important; border-radius: 50%; }
    .bogey-plus { background: #333 !important; color: white !important; border-radius: 0%; }
    .blob-state { opacity: 0.35; }

    .final-total-box { font-size: 1.1rem; font-weight: 900; color: white !important; }
    .round-1-theme .final-total-box { background: var(--emerald-dark) !important; }
    .round-2-theme .final-total-box { background: var(--round2-dark) !important; }

    /* TEAM TABLE IMPROVEMENTS */
    .team-table { width: 100%; border-radius: 12px; overflow: hidden; background: white; box-shadow: var(--shadow-soft); font-size: 0.85rem; border-collapse: collapse; margin-top: 10px;}
    .team-table thead th { padding: 10px; color: white; font-weight: 900; letter-spacing: 1px; }
    .team-header-row { background: #444; color: #fff !important; font-size: 0.7rem; }
    .team-header-row th { background: #444 !important; padding: 5px !important; }
    .team-table td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; }
    .team-player-name { text-align: left !important; padding-left: 15px !important; color: #333; }
    .team-total-row { background: #f8f9fa; font-weight: 900; font-size: 0.9rem; }

    #controls { text-align: center; margin-bottom: 15px; }
    button { padding: 10px 16px; font-size: 0.8rem; margin: 4px; cursor: pointer; border: none; border-radius: 8px; color: white; font-weight: 700; text-transform: uppercase; }
    .toggle-rd { background: #222; }
    .image-btn { background: #8e44ad; }
    .admin-only { display: none; background: #666; }

    .pts-label { font-weight: 800; font-size: 0.9rem; display: block; }
    .round-1-theme .pts-label { color: var(--emerald-primary); }
    .round-2-theme .pts-label { color: var(--round2-blue); }
  </style>
</head>
<body>

<div id="controls">
  <button class="toggle-rd" onclick="toggleRound()">Switch to Round <span id="next-rd-label">2</span></button>
  <button class="image-btn" onclick="saveAsImage()">ðŸ“¸ Export Image</button>
  <button class="admin-only" onclick="addPlayer()">+ Add Player</button>
  <button class="admin-only" onclick="exportData()">ðŸ“¤ Export JSON</button>
</div>

<div id="capture-area">
  <div class="header-block">
    <div class="brand-main">NEW EMERALD TOUR</div>
    <div class="sub-brand">Team Stableford Competition</div>
    <input type="text" id="venue-name" class="venue-input" placeholder="Enter Venue Name" oninput="saveState()" readonly>
  </div>
  
  <div style="text-align: center;">
    <div id="round-display" style="background: var(--emerald-dark); color: white; display: inline-block; padding: 6px 25px; border-radius: 30px; font-weight: 900; margin-bottom: 15px; letter-spacing: 1px; transition: 0.3s;">ROUND 1</div>
  </div>

  <div class="table-wrapper">
    <table id="scorecard" class="round-1-theme">
      <thead>
        <tr>
          <th class="col-name" style="text-align:left; padding-left:15px">Player</th>
          <th class="col-hcp">Hcp</th>
          <th class="col-team">T</th>
          <script>for(let i=1; i<=18; i++) document.write(`<th class="col-hole">${i}</th>`);</script>
          <th class="col-total">TOT</th>
        </tr>
        <tr style="background: #fafafa;"><td colspan="3" style="text-align:right; font-weight:800; color: #999; font-size: 0.55rem; padding-right: 10px;">PAR</td><script>for(let i=0; i<18; i++) document.write(`<td><input type="number" class="par-input" value="4" oninput="updateCalculations()"></td>`);</script><td>-</td></tr>
        <tr style="background: #fafafa;"><td colspan="3" style="text-align:right; font-weight:800; color: #999; font-size: 0.55rem; padding-right: 10px;">S.I.</td><script>for(let i=0; i<18; i++) document.write(`<td><input type="number" class="si-input" value="${i+1}" oninput="updateCalculations()"></td>`);</script><td>-</td></tr>
      </thead>
      <tbody id="players-body"></tbody>
    </table>
  </div>

  <div class="team-container">
    <table class="team-table">
        <thead>
            <tr id="team-a-head" style="background: var(--emerald-dark);"><th colspan="4"><input type="text" id="team-a-name" style="background:transparent; color:white; border:none; text-align:center; font-weight:900; width:100%; text-transform:uppercase" value="Team A" readonly></th></tr>
            <tr class="team-header-row"><th>PLAYER NAME</th><th>RD 1</th><th>RD 2</th><th>TOTAL</th></tr>
        </thead>
        <tbody id="team-a-body"></tbody>
        <tr class="team-total-row"><td>TEAM TOTAL</td><td id="tA-r1">0</td><td id="tA-r2">0</td><td id="tA-grand" style="color: var(--emerald-dark)">0</td></tr>
    </table>
    <br>
    <table class="team-table">
        <thead>
            <tr id="team-b-head" style="background: var(--emerald-dark);"><th colspan="4"><input type="text" id="team-b-name" style="background:transparent; color:white; border:none; text-align:center; font-weight:900; width:100%; text-transform:uppercase" value="Team B" readonly></th></tr>
            <tr class="team-header-row"><th>PLAYER NAME</th><th>RD 1</th><th>RD 2</th><th>TOTAL</th></tr>
        </thead>
        <tbody id="team-b-body"></tbody>
        <tr class="team-total-row"><td>TEAM TOTAL</td><td id="tB-r1">0</td><td id="tB-r2">0</td><td id="tB-grand" style="color: var(--emerald-dark)">0</td></tr>
    </table>
  </div>
</div>

<script>
// Logic remains robust with round colors extending to team tables
let players = [];
let currentViewingRound = 1;
const STORAGE_KEY = 'golf_elite_v24';

window.onload = () => { checkAdmin(); loadLocal(); };

function checkAdmin() {
  const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
  if (isAdmin) {
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
    document.querySelectorAll('input').forEach(el => el.readOnly = false);
  }
}

function loadLocal() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    const state = JSON.parse(saved);
    players = state.players || [];
    document.getElementById('venue-name').value = state.venueName || '';
    document.getElementById('team-a-name').value = state.teamAName || 'Team A';
    document.getElementById('team-b-name').value = state.teamBName || 'Team B';
    if(state.pars) state.pars.forEach((v, i) => document.querySelectorAll('.par-input')[i].value = v);
    if(state.sis) state.sis.forEach((v, i) => document.querySelectorAll('.si-input')[i].value = v);
  }
  renderPlayers();
}

function renderPlayers() {
  const tbody = document.getElementById('players-body');
  tbody.innerHTML = '';
  const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
  players.forEach((p, pIdx) => {
    const scores = currentViewingRound === 1 ? p.r1Scores : p.r2Scores;
    let trScore = `<tr><td style="text-align:left; padding-left:10px"><input class="player-name-input" value="${p.name}" ${isAdmin ? '' : 'readonly'} onchange="players[${pIdx}].name=this.value; saveState();"></td>
      <td><input type="number" class="score-input" value="${p.handicap}" ${isAdmin ? '' : 'readonly'} oninput="players[${pIdx}].handicap=this.value; updateCalculations();" style="background:#f9f9f9"></td>
      <td style="font-weight:900;">${p.team}</td>`;
    for(let i=0; i<18; i++) trScore += `<td><input type="number" class="score-input" data-p="${pIdx}" data-h="${i}" value="${scores[i] || ''}" ${isAdmin ? '' : 'readonly'} oninput="updateCalculations()"></td>`;
    trScore += `<td class="final-total-box">0</td></tr><tr style="background: rgba(0,0,0,0.02)"><td colspan="3" style="text-align:right; font-weight:800; color:#aaa; font-size:0.5rem; padding-right:5px">NET/PTS</td>`;
    for(let i=0; i<18; i++) trNet += `<td id="net-${pIdx}-${i}">-</td>`; // trNet is built here
    tbody.innerHTML += trScore;
    let trNet = ''; for(let i=0; i<18; i++) trNet += `<td id="net-${pIdx}-${i}">-</td>`;
    tbody.innerHTML += `<tr style="background: rgba(0,0,0,0.02)"><td colspan="3" style="text-align:right; font-weight:800; color:#aaa; font-size:0.5rem; padding-right:5px">NET/PTS</td>${trNet}<td id="p-total-${pIdx}" style="background:#333; color:white; font-weight:bold;">0</td></tr>`;
  });
  updateCalculations();
}

function updateCalculations() {
  players.forEach((p, pIdx) => {
    let rdTotal = 0;
    const hcap = parseInt(p.handicap) || 0;
    const inputs = document.querySelectorAll(`.score-input[data-p="${pIdx}"]`);
    inputs.forEach((inp, hIdx) => {
      const gross = parseInt(inp.value);
      const par = parseInt(document.querySelectorAll('.par-input')[hIdx].value) || 4;
      const si = parseInt(document.querySelectorAll('.si-input')[hIdx].value) || (hIdx + 1);
      inp.classList.remove('birdie', 'eagle', 'par-gross', 'bogey-plus', 'blob-state');
      if (currentViewingRound === 1) p.r1Scores[hIdx] = inp.value; else p.r2Scores[hIdx] = inp.value;
      const netCell = document.getElementById(`net-${pIdx}-${hIdx}`);
      if (!isNaN(gross) && gross > 0) {
        if (gross-par <= -2) inp.classList.add('eagle'); else if (gross-par === -1) inp.classList.add('birdie'); else if (gross-par === 0) inp.classList.add('par-gross'); else inp.classList.add('bogey-plus');
        const strokes = Math.floor(hcap / 18) + (si <= (hcap % 18) ? 1 : 0);
        const net = gross - strokes;
        let pts = (net-par <= -2) ? 4 : (net-par === -1) ? 3 : (net-par === 0) ? 2 : (net-par === 1) ? 1 : 0;
        if (pts === 0) inp.classList.add('blob-state');
        rdTotal += pts;
        netCell.innerHTML = `<span style="font-size:0.6rem; color:#888;">${net}</span><span class="pts-label">${pts}</span>`;
      } else { netCell.textContent = '-'; }
    });
    if (currentViewingRound === 1) p.r1Total = rdTotal; else p.r2Total = rdTotal;
    document.querySelectorAll('.final-total-box')[pIdx].textContent = rdTotal;
    document.getElementById(`p-total-${pIdx}`).textContent = rdTotal;
  });
  updateTeamTables();
  saveState();
}

function updateTeamTables() {
  const bodies = { A: document.getElementById('team-a-body'), B: document.getElementById('team-b-body') };
  const totals = { A: {r1:0, r2:0}, B: {r1:0, r2:0} };
  bodies.A.innerHTML = ''; bodies.B.innerHTML = '';
  players.forEach(p => {
    bodies[p.team].innerHTML += `<tr><td class="team-player-name" style="font-weight:700">${p.name}</td><td>${p.r1Total}</td><td>${p.r2Total}</td><td style="font-weight:900">${p.r1Total+p.r2Total}</td></tr>`;
    totals[p.team].r1 += p.r1Total; totals[p.team].r2 += p.r2Total;
  });
  ['A', 'B'].forEach(t => {
    document.getElementById(`t${t}-r1`).textContent = totals[t].r1;
    document.getElementById(`t${t}-r2`).textContent = totals[t].r2;
    document.getElementById(`t${t}-grand`).textContent = totals[t].r1 + totals[t].r2;
  });
}

function saveState() {
  const state = { players, venueName: document.getElementById('venue-name').value, teamAName: document.getElementById('team-a-name').value, teamBName: document.getElementById('team-b-name').value, pars: Array.from(document.querySelectorAll('.par-input')).map(i => i.value), sis: Array.from(document.querySelectorAll('.si-input')).map(i => i.value) };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function toggleRound() {
  currentViewingRound = currentViewingRound === 1 ? 2 : 1;
  const card = document.getElementById('scorecard');
  const indicator = document.getElementById('round-display');
  const themeColor = currentViewingRound === 1 ? 'var(--emerald-dark)' : 'var(--round2-blue)';
  card.className = currentViewingRound === 1 ? 'round-1-theme' : 'round-2-theme';
  indicator.style.background = themeColor;
  indicator.textContent = `ROUND ${currentViewingRound}`;
  document.getElementById('next-rd-label').textContent = currentViewingRound === 1 ? 2 : 1;
  document.getElementById('team-a-head').style.background = themeColor;
  document.getElementById('team-b-head').style.background = themeColor;
  renderPlayers();
}

function addPlayer() {
  const name = prompt("Name:"); if (!name) return;
  const team = prompt("Team (A or B):", "A").toUpperCase();
  players.push({ name, handicap: 0, team: (team === 'B' ? 'B' : 'A'), r1Scores: Array(18).fill(''), r2Scores: Array(18).fill(''), r1Total: 0, r2Total: 0 });
  renderPlayers();
  saveState();
}

function exportData() {
  const state = localStorage.getItem(STORAGE_KEY);
  const blob = new Blob([state], {type: "application/json"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `emerald_tour.json`; a.click();
}

function saveAsImage() {
  html2canvas(document.getElementById('capture-area'), { scale: 2, backgroundColor: '#e8ecef' }).then(canvas => {
    const link = document.createElement('a'); link.download = `Emerald_Tour_Scorecard.png`; link.href = canvas.toDataURL(); link.click();
  });
}
</script>
</body>
</html>