<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>New Emerald Tour - Elite Scoreboard</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --emerald-primary: #2e7d32;
      --emerald-dark: #1b5e20;
      --round2-blue: #1565c0;
      --round2-dark: #0d47a1;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(255, 255, 255, 0.3);
      --shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    * { box-sizing: border-box; } /* Ensures padding doesn't push widths out */

    html, body { width: 100%; margin: 0; padding: 0; background: #e8ecef; background-image: linear-gradient(135deg, #e8ecef 0%, #c8e6c9 100%); background-attachment: fixed; }
    body { font-family: 'Inter', -apple-system, sans-serif; padding: 10px; }
    
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; appearance: textfield; }

    .header-block { text-align: center; margin-bottom: 15px; }
    .brand-main { font-size: 1.1rem; font-weight: 900; letter-spacing: 4px; text-transform: uppercase; color: var(--emerald-dark); margin: 0; }
    .sub-brand { font-size: 0.8rem; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; color: #555; margin: 2px 0; }
    .venue-input { border: none; background: transparent; font-weight: 800; text-align: center; color: #000; width: 90%; font-size: 1.3rem; text-transform: uppercase; outline: none; }

    #capture-area { padding: 10px; border-radius: 16px; border: 1px solid var(--glass-border); }

    .table-wrapper { 
      width: 100%; overflow-x: auto; border-radius: 10px; box-shadow: var(--shadow-soft); 
      margin-bottom: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border);
    }
    table { border-collapse: separate; border-spacing: 0; width: 100%; }
    th { color: white; text-transform: uppercase; font-size: 0.6rem; letter-spacing: 1px; padding: 6px 2px; }
    td { border-bottom: 1px solid rgba(0,0,0,0.05); padding: 2px; text-align: center; }
    
    .round-1-theme th { background: linear-gradient(180deg, var(--emerald-primary), var(--emerald-dark)); }
    .round-2-theme th { background: linear-gradient(180deg, var(--round2-blue), var(--round2-dark)); }
    
    .col-name { width: 130px; min-width: 130px; }
    .col-hcp, .col-team { width: 35px; min-width: 35px; }
    .col-hole { width: 32px; min-width: 32px; }
    .col-total { width: 50px; min-width: 50px; }

    .score-input, .par-input, .si-input { width: 28px; height: 28px; border: 1px solid #ddd; text-align: center; border-radius: 4px; font-weight: 700; background: white; font-size: 0.8rem; outline: none; margin: 0 auto; display: block; }
    .player-name-input { font-weight: 800; border: none; background: transparent; color: #333; font-size: 0.8rem; padding-left: 5px; width: 100%; outline: none; }
    
    .eagle { border: 2px solid #b8860b !important; border-radius: 50%; width: 24px; height: 24px; line-height: 22px; margin: 0 auto; background: #ffd700 !important; color: #000 !important; }
    .birdie { background: #d32f2f !important; color: white !important; border-radius: 50%; width: 24px; height: 24px; line-height: 24px; margin: 0 auto; }
    .par-gross { background: #2e7d32 !important; color: white !important; border-radius: 50%; width: 24px; height: 24px; line-height: 24px; margin: 0 auto; }
    .bogey-plus { background: #333 !important; color: white !important; width: 24px; height: 24px; line-height: 24px; margin: 0 auto; }
    .blob-state { opacity: 0.35; }

    .final-total-box { font-size: 1rem !important; color: white !important; }
    .round-1-theme .final-total-box { background: var(--emerald-dark) !important; }
    .round-2-theme .final-total-box { background: var(--round2-dark) !important; }
    .pts-label { font-weight: 800; font-size: 0.8rem; display: block; }

    /* TEAM TABLES ALIGNMENT */
    .team-container { 
      display: flex; 
      gap: 15px; 
      justify-content: space-between; 
      margin-top: 10px;
    }
    .team-table-wrapper { flex: 1; min-width: 0; }
    .team-table { 
      width: 100%; 
      table-layout: fixed; /* ESSENTIAL FOR WIDTHS */
      border-radius: 10px; 
      overflow: hidden; 
	  text-overflow: ellipsis;
		white-space: nowrap;
      background: white; 
      box-shadow: var(--shadow-soft); 
      font-size: 0.8rem; 
      border-collapse: collapse; 
    }

    /* SPECIFIC TEAM COLUMN WIDTHS - Name gets 50%, scores get ~16% each */
    .team-header-row th:nth-child(1) { width: 55%; } /* PLAYER */
	.team-header-row th:nth-child(2) { width: 15%; } /* R1 */
	.team-header-row th:nth-child(3) { width: 15%; } /* R2 */
	.team-header-row th:nth-child(4) { width: 15%; } /* TOT */

    .team-table thead th { padding: 8px 4px; color: white; font-weight: 900; }
    .team-header-row th { background: #f1f3f5 !important; color: #666 !important; font-size: 0.6rem !important; padding: 4px !important; }
    .team-table td { padding: 8px 4px; text-align: center; border-bottom: 1px solid #eee; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .team-player-name { text-align: left !important; padding-left: 12px !important; color: #333; font-weight: 700; font-size: 0.75rem; }
    .team-total-row { background: #f8f9fa; font-weight: 900; }

    #controls { text-align: center; margin-bottom: 10px; }
    button { padding: 8px 14px; font-size: 0.75rem; margin: 2px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: 700; text-transform: uppercase; }
    .toggle-rd { background: #222; }
    .image-btn { background: #8e44ad; }
    .admin-only { display: none; background: #666; }

    @media (max-width: 700px) {
      .team-container { flex-direction: column; }
    }
  </style>
</head>
<body>

<div id="controls">
  <button class="toggle-rd" onclick="toggleRound()">Round <span id="next-rd-label">2</span></button>
  <button class="image-btn" onclick="saveAsImage()">üì∏ Export</button>
  <button class="admin-only" onclick="addPlayer()">+ Player</button>
  <button class="admin-only" onclick="exportData()">üíæ JSON</button>
  <button class="admin-only" onclick="resetScores()" style="background: #c0392b;">üóëÔ∏è Reset Scores</button>
</div>

<div id="capture-area">
  <div class="header-block">
    <div class="brand-main">NEW EMERALD TOUR</div>
    <div class="sub-brand">Team Stableford Competition</div>
    <input type="text" id="venue-name" class="venue-input" placeholder="ENTER VENUE" readonly>
  </div>
  
  <div style="text-align: center;">
    <div id="round-display" style="background: var(--emerald-dark); color: white; display: inline-block; padding: 6px 20px; border-radius: 20px; font-weight: 900; margin-bottom: 10px; font-size: 0.8rem;">ROUND 1</div>
  </div>

  <div class="table-wrapper">
    <table id="scorecard" class="round-1-theme">
      <thead>
        <tr>
          <th class="col-name" style="text-align:left; padding-left:15px">Player</th>
          <th class="col-hcp">Hcp</th>
          <th class="col-team">T</th>
          <script>for(let i=1; i<=18; i++) document.write(`<th class="col-hole">${i}</th>`);</script>
          <th class="col-total">TOT</th>
        </tr>
        <tr style="background: #fafafa;">
          <td colspan="3" style="text-align:right; font-weight:800; color:#aaa; font-size:0.5rem; padding-right:5px">PAR</td>
          <script>for(let i=0; i<18; i++) document.write(`<td><input type="number" class="par-input" value="4" oninput="updateCalculations()"></td>`);</script>
          <td>-</td>
        </tr>
        <tr style="background: #fafafa;">
          <td colspan="3" style="text-align:right; font-weight:800; color:#aaa; font-size:0.5rem; padding-right:5px">S.I.</td>
          <script>for(let i=0; i<18; i++) document.write(`<td><input type="number" class="si-input" value="${i+1}" oninput="updateCalculations()"></td>`);</script>
          <td>-</td>
        </tr>
      </thead>
      <tbody id="players-body"></tbody>
    </table>
  </div>

  <div class="team-container">
    <div class="team-table-wrapper">
        <table class="team-table">
            <thead>
                <tr id="team-a-head" style="background: var(--emerald-dark);"><th colspan="4"><input type="text" id="team-a-name" style="background:transparent; color:white; border:none; text-align:center; font-weight:900; width:100%; text-transform:uppercase; outline:none;" value="Team A" readonly></th></tr>
                <tr class="team-header-row"><th style="text-align:left; padding-left:12px;">PLAYER</th><th>R1</th><th>R2</th><th>TOT</th></tr>
            </thead>
            <tbody id="team-a-body"></tbody>
            <tr class="team-total-row" id="team-a-footer"></tr>
        </table>
    </div>
    <div class="team-table-wrapper">
        <table class="team-table">
            <thead>
                <tr id="team-b-head" style="background: var(--emerald-dark);"><th colspan="4"><input type="text" id="team-b-name" style="background:transparent; color:white; border:none; text-align:center; font-weight:900; width:100%; text-transform:uppercase; outline:none;" value="Team B" readonly></th></tr>
                <tr class="team-header-row"><th style="text-align:left; padding-left:12px;">PLAYER</th><th>R1</th><th>R2</th><th>TOT</th></tr>
            </thead>
            <tbody id="team-b-body"></tbody>
            <tr class="team-total-row" id="team-b-footer"></tr>
        </table>
    </div>
  </div>
</div>

<script>
let players = [];
let currentViewingRound = 1;
const STORAGE_KEY = 'golf_elite_v29';

window.onload = () => { checkAdmin(); loadOfficialData(); };

function checkAdmin() {
  if (new URLSearchParams(window.location.search).get('admin') === 'true') {
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
    document.querySelectorAll('input').forEach(el => el.readOnly = false);
  }
}

async function loadOfficialData() {
  try {
    const response = await fetch('data.json?t=' + Date.now());
    if (response.ok) { applyState(await response.json()); } 
    else { loadLocal(); }
  } catch (e) { loadLocal(); }
}

function loadLocal() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) applyState(JSON.parse(saved));
}

function applyState(state) {
  if (!state) return;
  players = state.players || [];
  document.getElementById('venue-name').value = state.venueName || '';
  document.getElementById('team-a-name').value = state.teamAName || 'Team A';
  document.getElementById('team-b-name').value = state.teamBName || 'Team B';
  const parInputs = document.querySelectorAll('.par-input');
  const siInputs = document.querySelectorAll('.si-input');
  if (state.pars) state.pars.forEach((v, i) => { if(parInputs[i]) parInputs[i].value = v; });
  if (state.sis) state.sis.forEach((v, i) => { if(siInputs[i]) siInputs[i].value = v; });
  renderPlayers();
}

function renderPlayers() {
  const tbody = document.getElementById('players-body');
  tbody.innerHTML = '';
  const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
  players.forEach((p, pIdx) => {
    const scores = currentViewingRound === 1 ? p.r1Scores : p.r2Scores;
    let trScore = `<tr><td style="text-align:left; padding-left:8px"><input class="player-name-input" value="${p.name}" ${isAdmin ? '' : 'readonly'} onchange="players[${pIdx}].name=this.value; saveState();"></td>
      <td><input type="number" class="score-input" value="${p.handicap}" ${isAdmin ? '' : 'readonly'} oninput="players[${pIdx}].handicap=this.value; updateCalculations();" style="background:#f9f9f9"></td>
      <td style="font-weight:700; font-size:0.7rem;">${p.team}</td>`;
    for(let i=0; i<18; i++) trScore += `<td><input type="number" class="score-input" data-p="${pIdx}" data-h="${i}" value="${scores[i] || ''}" ${isAdmin ? '' : 'readonly'} oninput="updateCalculations()"></td>`;
    trScore += `<td class="final-total-box" id="tot-gross-${pIdx}" style="font-weight: 900;">0</td></tr>`;
    let trNet = ''; for(let i=0; i<18; i++) trNet += `<td id="net-${pIdx}-${i}" style="padding:1px 0;">-</td>`;
    tbody.innerHTML += trScore + `<tr style="background: rgba(0,0,0,0.02); height:22px"><td colspan="3" style="text-align:right; font-weight:700; color:#aaa; font-size:0.45rem; padding-right:5px">NET/PTS</td>${trNet}<td id="p-total-${pIdx}" style="background:#333; color:white; font-weight:bold; font-size:0.75rem;">0</td></tr>`;
  });
  updateCalculations();
}

function updateCalculations() {
  players.forEach((p, pIdx) => {
    let rdStb = 0, rdGross = 0;
    const hcap = parseInt(p.handicap) || 0;
    const inputs = document.querySelectorAll(`.score-input[data-p="${pIdx}"]`);
    inputs.forEach((inp, hIdx) => {
      const gross = parseInt(inp.value), par = parseInt(document.querySelectorAll('.par-input')[hIdx].value) || 4, si = parseInt(document.querySelectorAll('.si-input')[hIdx].value) || (hIdx + 1);
      inp.classList.remove('birdie', 'eagle', 'par-gross', 'bogey-plus', 'blob-state');
      if (currentViewingRound === 1) p.r1Scores[hIdx] = inp.value; else p.r2Scores[hIdx] = inp.value;
      const netCell = document.getElementById(`net-${pIdx}-${hIdx}`);
      if (!isNaN(gross) && gross > 0) {
        rdGross += gross;
        if (gross-par <= -2) inp.classList.add('eagle'); else if (gross-par === -1) inp.classList.add('birdie'); else if (gross-par === 0) inp.classList.add('par-gross'); else inp.classList.add('bogey-plus');
        const net = gross - (Math.floor(hcap/18) + (si <= (hcap%18) ? 1 : 0));
        let pts = Math.max(0, 2 - (net - par));
        if (pts === 0) inp.classList.add('blob-state');
        rdStb += pts;
        netCell.innerHTML = `<span style="font-size:0.5rem; color:#888; display:block; line-height:1;">${net}</span><span class="pts-label" style="color:${currentViewingRound==1?'var(--emerald-primary)':'var(--round2-blue)'}">${pts}</span>`;
      } else { netCell.textContent = '-'; }
    });
    if (currentViewingRound === 1) p.r1Total = rdStb; else p.r2Total = rdStb;
    document.getElementById(`tot-gross-${pIdx}`).textContent = rdGross;
    document.getElementById(`p-total-${pIdx}`).textContent = rdStb;
  });
  updateTeamTables();
  saveState();
}

function updateTeamTables() {
  const bodies = { A: document.getElementById('team-a-body'), B: document.getElementById('team-b-body') };
  const totals = { A: {r1:0, r2:0}, B: {r1:0, r2:0} };
  bodies.A.innerHTML = ''; bodies.B.innerHTML = '';
  const h1 = currentViewingRound === 1 ? 'style="background:rgba(46,125,50,0.1); font-weight:800; color:var(--emerald-dark)"' : '';
  const h2 = currentViewingRound === 2 ? 'style="background:rgba(21,101,192,0.1); font-weight:800; color:var(--round2-blue)"' : '';
  
  players.forEach(p => {
    bodies[p.team].innerHTML += `<tr><td class="team-player-name">${p.name}</td><td ${h1}>${p.r1Total}</td><td ${h2}>${p.r2Total}</td><td style="font-weight:900; background:#fcfcfc">${p.r1Total+p.r2Total}</td></tr>`;
    totals[p.team].r1 += p.r1Total; totals[p.team].r2 += p.r2Total;
  });
  
  ['A', 'B'].forEach(t => {
    const footerId = t === 'A' ? 'team-a-footer' : 'team-b-footer';
    document.getElementById(footerId).innerHTML = `<td style="text-align:left; padding-left:12px; font-weight:900; text-transform:uppercase; font-size:0.6rem; color:#555;">Team Total</td><td ${h1}>${totals[t].r1}</td><td ${h2}>${totals[t].r2}</td><td style="color:${currentViewingRound==1?'var(--emerald-dark)':'var(--round2-blue)'}; font-weight:900; font-size:0.85rem; background:#f0f0f0;">${totals[t].r1+totals[t].r2}</td>`;
  });
}

function toggleRound() {
  currentViewingRound = currentViewingRound === 1 ? 2 : 1;
  const theme = currentViewingRound === 1 ? 'var(--emerald-dark)' : 'var(--round2-blue)';
  document.getElementById('scorecard').className = currentViewingRound === 1 ? 'round-1-theme' : 'round-2-theme';
  document.getElementById('round-display').style.background = theme;
  document.getElementById('round-display').textContent = `ROUND ${currentViewingRound}`;
  document.getElementById('next-rd-label').textContent = currentViewingRound === 1 ? 2 : 1;
  document.getElementById('team-a-head').style.background = theme;
  document.getElementById('team-b-head').style.background = theme;
  renderPlayers();
}

function saveState() {
  const state = { players, venueName: document.getElementById('venue-name').value, teamAName: document.getElementById('team-a-name').value, teamBName: document.getElementById('team-b-name').value, pars: Array.from(document.querySelectorAll('.par-input')).map(i => i.value), sis: Array.from(document.querySelectorAll('.si-input')).map(i => i.value) };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function addPlayer() {
  const name = prompt("Name:"), team = prompt("Team (A/B):", "A").toUpperCase();
  if (name) players.push({ name, handicap: 0, team: (team === 'B' ? 'B' : 'A'), r1Scores: Array(18).fill(''), r2Scores: Array(18).fill(''), r1Total: 0, r2Total: 0 });
  renderPlayers();
}

function exportData() {
  const blob = new Blob([localStorage.getItem(STORAGE_KEY)], {type: "application/json"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `emerald_data.json`; a.click();
}

function saveAsImage() {
  html2canvas(document.getElementById('capture-area'), { scale: 2, backgroundColor: '#e8ecef' }).then(canvas => {
    const link = document.createElement('a'); link.download = `Emerald_Tour_Scorecard.png`; link.href = canvas.toDataURL(); link.click();
  });
}

function resetScores() {
  if (confirm("Are you sure? This will clear Venue, Pars, S.I., and all Scores. Names will be kept.")) {
    document.getElementById('venue-name').value = '';
    document.querySelectorAll('.par-input').forEach(input => input.value = '4');
    document.querySelectorAll('.si-input').forEach((input, i) => input.value = i + 1);
    players.forEach(p => {
      p.r1Scores = Array(18).fill('');
      p.r2Scores = Array(18).fill('');
      p.r1Total = 0;
      p.r2Total = 0;
    });
    renderPlayers();
    saveState();
  }
}
</script>
</body>
</html>