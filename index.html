<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
  <title>New Emerald Tour - Scoreboard</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    html, body { width: 100%; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 5px; background: #f0f2f5; box-sizing: border-box; }
    
    h1 { color: #1b5e20; text-align: center; margin: 5px 0 2px 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.5px; }
    
    #mode-tag { font-size: 0.6rem; color: #777; text-align: center; margin-bottom: 5px; font-style: italic; }
    .venue-container { text-align: center; margin-bottom: 5px; }
    .venue-input { border: none; border-bottom: 1px solid #2e7d32; background: transparent; font-size: 1rem; text-align: center; width: 60%; color: #333; font-weight: bold; }
    .round-indicator { text-align: center; font-size: 0.9rem; font-weight: bold; color: #1565c0; margin-bottom: 8px; background: white; display: inline-block; padding: 2px 12px; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-left: 50%; transform: translateX(-50%); }
    
    #capture-area { padding: 5px; background: #f0f2f5; width: 100%; box-sizing: border-box; }

    /* The container that allows swiping */
    .table-wrapper { 
      width: 100%; 
      overflow-x: auto; 
      border-radius: 8px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
      margin-bottom: 15px;
      background: white;
      -webkit-overflow-scrolling: touch;
    }
    
    table { border-collapse: separate; border-spacing: 0; background: white; }

    /* PORTRAIT: Force a wide table so it doesn't squash */
    @media screen and (orientation: portrait) {
      table { width: 900px; table-layout: fixed; }
      .col-name { width: 110px; }
      .col-hcp { width: 35px; }
      .col-team { width: 25px; }
      .col-hole { width: 38px; }
      .col-total { width: 45px; }
      th, td { font-size: 0.85rem; padding: 6px 2px; }
    }

    /* LANDSCAPE: Shrink everything to fit on one screen */
    @media screen and (orientation: landscape) {
      .table-wrapper { overflow-x: hidden; } 
      table { width: 100%; table-layout: fixed; }
      th, td { font-size: 0.7rem; padding: 2px 0; }
      .player-name-input { width: 80px !important; font-size: 0.75rem !important; }
      .score-input, .par-input, .si-input { width: 22px !important; height: 22px !important; font-size: 0.8rem !important; }
      .col-name { width: 85px; }
      .col-hcp { width: 28px; }
      .col-team { width: 22px; }
      .col-hole { width: auto; } 
      .col-total { width: 35px; }
    }

    th, td { border: 0.5px solid #ddd; text-align: center; }
    th { background: #2e7d32; color: white; }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .score-input, .par-input, .si-input { width: 28px; height: 28px; border: 1px solid #ccc; text-align: center; border-radius: 3px; font-size: 0.9rem; }
    .par-input, .si-input { background: #fff8e1; font-weight: bold; border-color: #ffd54f; }
    
    .player-name-input { font-weight: bold; border: none; background: transparent; width: 100%; font-size: 0.85rem; }
    .final-total-box { font-size: 1rem; font-weight: bold; color: #1b5e20; background: #c8e6c9 !important; }

    #controls { text-align: center; margin-bottom: 10px; background: #fff; padding: 5px; border-radius: 8px; }
    button { padding: 6px 10px; font-size: 0.75rem; margin: 2px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: 800; }
    .toggle-rd { background: #1565c0; }
    .image-btn { background: #673ab7; }
    .admin-only { display: none; background: #4caf50; }

    .net-pts-row { background: #f1f8e9; line-height: 1.1; }
    .net-label { font-size: 0.55rem; color: #777; display: block; }
    .pts-label { font-size: 0.75rem; color: #2e7d32; font-weight: bold; }

    .team-container { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; width: 100%; }
    .team-table { width: 100%; border-radius: 8px; overflow: hidden; background: white; font-size: 0.85rem; border-collapse: collapse; }
    .team-table th, .team-table td { padding: 8px 4px; }
    
    @media (min-width: 768px) { 
      .team-container { flex-direction: row; justify-content: space-between; } 
      .team-table { width: 49%; } 
    }
  </style>
</head>
<body>

<div id="controls">
  <button class="toggle-rd" onclick="toggleRound()">Rd <span id="next-rd-label">2</span></button>
  <button class="image-btn" onclick="saveAsImage()">üì∏ Capture</button>
  <button class="admin-only" onclick="addPlayer()">+ Player</button>
  <button class="admin-only" onclick="recordToHistory()">üèÜ Record</button>
  <button class="admin-only" onclick="exportData()">üì§ Export</button>
</div>

<div id="capture-area">
  <h1>New Emerald Tour - Team Stableford Scorecard</h1>
  <div id="mode-tag">Member View</div>
  <div class="venue-container">
    <input type="text" id="venue-name" class="venue-input" placeholder="Venue Name" oninput="saveState()" readonly>
  </div>
  <div id="round-display" class="round-indicator">Round 1</div>

  <div class="table-wrapper">
    <table id="scorecard">
      <thead>
        <tr>
          <th class="col-name">Player</th>
          <th class="col-hcp">H</th>
          <th class="col-team">T</th>
          <script>for(let i=1; i<=18; i++) document.write(`<th class="col-hole">${i}</th>`);</script>
          <th class="col-total">Tot</th>
        </tr>
        <tr id="par-row"><td colspan="3" style="text-align:right; font-weight:bold; background:#eee;">PAR</td></tr>
        <tr id="si-row"><td colspan="3" style="text-align:right; font-weight:bold; background:#eee;">SI</td></tr>
      </thead>
      <tbody id="players-body"></tbody>
    </table>
  </div>

  <div class="team-container">
    <table class="team-table" id="team-a-display">
        <thead><tr style="background:#1b5e20; color:white"><th colspan="4"><input type="text" id="team-a-name" style="background:transparent; color:white; border:none; text-align:center; font-weight:bold; width:100%" value="Team A" readonly></th></tr>
        <tr style="background:#f1f8e9"><th>Name</th><th>R1</th><th>R2</th><th>Tot</th></tr></thead>
        <tbody id="team-a-body"></tbody>
        <tr style="background:#e8f5e9; font-weight:bold"><td>Total</td><td id="tA-r1">0</td><td id="tA-r2">0</td><td id="tA-grand">0</td></tr>
    </table>
    <table class="team-table" id="team-b-display">
        <thead><tr style="background:#1b5e20; color:white"><th colspan="4"><input type="text" id="team-b-name" style="background:transparent; color:white; border:none; text-align:center; font-weight:bold; width:100%" value="Team B" readonly></th></tr>
        <tr style="background:#f1f8e9"><th>Name</th><th>R1</th><th>R2</th><th>Tot</th></tr></thead>
        <tbody id="team-b-body"></tbody>
        <tr style="background:#e8f5e9; font-weight:bold"><td>Total</td><td id="tB-r1">0</td><td id="tB-r2">0</td><td id="tB-grand">0</td></tr>
    </table>
  </div>
</div>

<script>
let players = [];
let currentViewingRound = 1;
const STORAGE_KEY = 'golf_compact_v5';
const REMOTE_DATA_URL = 'data.json';

window.onload = () => {
  initializeHeader(); 
  checkAdmin();      
  loadOfficialData();
};

function checkAdmin() {
  const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
  if (isAdmin) {
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
    document.querySelectorAll('input').forEach(el => el.readOnly = false);
    document.getElementById('mode-tag').textContent = "ADMIN MODE";
  }
}

function initializeHeader() {
  const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
  const pRow = document.getElementById('par-row');
  const sRow = document.getElementById('si-row');
  while(pRow.cells.length > 1) pRow.deleteCell(1);
  while(sRow.cells.length > 1) sRow.deleteCell(1);
  for (let i = 1; i <= 18; i++) {
    pRow.innerHTML += `<td><input type="number" class="par-input" value="4" ${isAdmin ? '' : 'readonly'} oninput="updateCalculations()"></td>`;
    sRow.innerHTML += `<td><input type="number" class="si-input" value="${i}" ${isAdmin ? '' : 'readonly'} oninput="updateCalculations()"></td>`;
  }
}

async function loadOfficialData() {
  try {
    const response = await fetch(REMOTE_DATA_URL + '?t=' + Date.now());
    if (response.ok) applyState(await response.json());
    else loadLocal();
  } catch (e) { loadLocal(); }
}

function loadLocal() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) applyState(JSON.parse(saved));
}

function applyState(state) {
  players = state.players || [];
  document.getElementById('venue-name').value = state.venueName || '';
  document.getElementById('team-a-name').value = state.teamAName || 'Team A';
  document.getElementById('team-b-name').value = state.teamBName || 'Team B';
  if(state.pars) state.pars.forEach((v, i) => { if(document.querySelectorAll('.par-input')[i]) document.querySelectorAll('.par-input')[i].value = v; });
  if(state.sis) state.sis.forEach((v, i) => { if(document.querySelectorAll('.si-input')[i]) document.querySelectorAll('.si-input')[i].value = v; });
  renderPlayers();
}

function renderPlayers() {
  const tbody = document.getElementById('players-body');
  tbody.innerHTML = '';
  const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
  players.forEach((p, pIdx) => {
    const scores = currentViewingRound === 1 ? p.r1Scores : p.r2Scores;
    let trScore = `<tr>
      <td style="text-align:left"><input class="player-name-input" value="${p.name}" ${isAdmin ? '' : 'readonly'} onchange="players[${pIdx}].name=this.value; saveState();"></td>
      <td><input type="number" class="score-input" value="${p.handicap}" ${isAdmin ? '' : 'readonly'} oninput="players[${pIdx}].handicap=this.value; updateCalculations();"></td>
      <td style="font-weight:bold">${p.team}</td>`;
    for(let i=0; i<18; i++) trScore += `<td><input type="number" class="score-input" data-p="${pIdx}" data-h="${i}" value="${scores[i] || ''}" ${isAdmin ? '' : 'readonly'} oninput="updateCalculations()"></td>`;
    trScore += `<td style="background:#eee;"></td></tr>`;
    let trNet = `<tr class="net-pts-row"><td colspan="3" style="text-align:right; font-size:0.5rem; color:#777;">N/P</td>`;
    for(let i=0; i<18; i++) trNet += `<td id="net-${pIdx}-${i}">-</td>`;
    trNet += `<td id="p-total-${pIdx}" class="final-total-box">0</td></tr>`;
    tbody.innerHTML += trScore + trNet;
  });
  updateCalculations();
}

function updateCalculations() {
  players.forEach((p, pIdx) => {
    let rdTotal = 0;
    const hcap = parseInt(p.handicap) || 0;
    const inputs = document.querySelectorAll(`.score-input[data-p="${pIdx}"]`);
    inputs.forEach((inp, hIdx) => {
      const score = parseInt(inp.value);
      const par = parseInt(document.querySelectorAll('.par-input')[hIdx].value) || 4;
      const si = parseInt(document.querySelectorAll('.si-input')[hIdx].value) || (hIdx + 1);
      if (currentViewingRound === 1) p.r1Scores[hIdx] = inp.value; else p.r2Scores[hIdx] = inp.value;
      const netCell = document.getElementById(`net-${pIdx}-${hIdx}`);
      if (!isNaN(score) && score > 0) {
        const strokes = Math.floor(hcap / 18) + (si <= (hcap % 18) ? 1 : 0);
        const net = score - strokes;
        const diff = net - par;
        let pts = (diff <= -2) ? 4 : (diff === -1) ? 3 : (diff === 0) ? 2 : (diff === 1) ? 1 : 0;
        rdTotal += pts;
        netCell.innerHTML = `<span class="net-label">${net}</span><span class="pts-label">${pts}</span>`;
      } else { netCell.textContent = '-'; }
    });
    if (currentViewingRound === 1) p.r1Total = rdTotal; else p.r2Total = rdTotal;
    document.getElementById(`p-total-${pIdx}`).textContent = rdTotal;
  });
  updateTeamTables();
  saveState();
}

function updateTeamTables() {
  const bodies = { A: document.getElementById('team-a-body'), B: document.getElementById('team-b-body') };
  const totals = { A: {r1:0, r2:0}, B: {r1:0, r2:0} };
  bodies.A.innerHTML = ''; bodies.B.innerHTML = '';
  players.forEach(p => {
    bodies[p.team].innerHTML += `<tr><td>${p.name}</td><td>${p.r1Total}</td><td>${p.r2Total}</td><td>${p.r1Total+p.r2Total}</td></tr>`;
    totals[p.team].r1 += p.r1Total; totals[p.team].r2 += p.r2Total;
  });
  ['A', 'B'].forEach(t => {
    document.getElementById(`t${t}-r1`).textContent = totals[t].r1;
    document.getElementById(`t${t}-r2`).textContent = totals[t].r2;
    document.getElementById(`t${t}-grand`).textContent = totals[t].r1 + totals[t].r2;
  });
}

function saveState() {
  if (new URLSearchParams(window.location.search).get('admin') !== 'true') return;
  const state = { players, venueName: document.getElementById('venue-name').value, teamAName: document.getElementById('team-a-name').value, teamBName: document.getElementById('team-b-name').value, pars: Array.from(document.querySelectorAll('.par-input')).slice(0,18).map(i => i.value), sis: Array.from(document.querySelectorAll('.si-input')).slice(0,18).map(i => i.value) };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function toggleRound() {
  currentViewingRound = currentViewingRound === 1 ? 2 : 1;
  document.getElementById('round-display').textContent = `Round ${currentViewingRound}`;
  document.getElementById('next-rd-label').textContent = currentViewingRound === 1 ? 2 : 1;
  renderPlayers();
}

function addPlayer() {
  const name = prompt("Name:"); if (!name) return;
  const team = prompt("Team (A or B):", "A").toUpperCase();
  players.push({ name, handicap: 0, team: (team === 'B' ? 'B' : 'A'), r1Scores: Array(18).fill(''), r2Scores: Array(18).fill(''), r1Total: 0, r2Total: 0 });
  renderPlayers();
  saveState();
}

function exportData() {
  const state = localStorage.getItem(STORAGE_KEY);
  const blob = new Blob([state], {type: "application/json"});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `data.json`; a.click();
}

function saveAsImage() {
  html2canvas(document.getElementById('capture-area'), { scale: 2 }).then(canvas => {
    const link = document.createElement('a'); link.download = `Scores.png`; link.href = canvas.toDataURL(); link.click();
  });
}
</script>
</body>
</html>